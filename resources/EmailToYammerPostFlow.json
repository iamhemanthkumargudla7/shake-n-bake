{
   "$schema":"https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
   "contentVersion":"1.0.0.0",
   "parameters":{
      "logicAppName":{
         "type":"String",
         "metadata":{
            "description":"Name of the logic app."
         }
      },
      "logicAppLocation":{
         "defaultValue":"[resourceGroup().location]",
         "allowedValues":[
            "eastasia",
            "southeastasia",
            "centralus",
            "eastus",
            "eastus2",
            "westus",
            "northcentralus",
            "southcentralus",
            "northeurope",
            "westeurope",
            "japanwest",
            "japaneast",
            "brazilsouth",
            "australiaeast",
            "australiasoutheast",
            "southindia",
            "centralindia",
            "westindia",
            "canadacentral",
            "canadaeast",
            "uaecentral",
            "westcentralus",
            "westus2",
            "[resourceGroup().location]"
         ],
         "type":"String",
         "metadata":{
            "description":"Location of the logic app."
         }
      },
      "yammer_Connection_Name":{
         "defaultValue":"yammer",
         "type":"String",
         "metadata":{
            "description":"Name of the connection."
         }
      },
      "office365_1_Connection_Name":{
         "defaultValue":"office365_1",
         "type":"String",
         "metadata":{
            "description":"Name of the connection."
         }
      }
   },
   "resources":[
      {
         "type":"Microsoft.Logic/workflows",
         "apiVersion":"2016-06-01",
         "name":"[parameters('logicAppName')]",
         "location":"[parameters('logicAppLocation')]",
         "dependsOn":[
            "[resourceId('Microsoft.Web/connections', parameters('yammer_Connection_Name'))]",
            "[resourceId('Microsoft.Web/connections', parameters('office365_1_Connection_Name'))]"
         ],
         "properties":{
            "state":"Disabled",
            "definition":{
               "$schema":"https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
               "contentVersion":"1.0.0.0",
               "parameters":{
                  "$connections":{
                     "defaultValue":{

                     },
                     "type":"Object"
                  },
                  "$authentication":{
                     "defaultValue":{

                     },
                     "type":"SecureObject"
                  }
               },
               "triggers":{
                  "When_a_new_email_arrives_(V3)":{
                     "splitOn":"@triggerBody()?['value']",
                     "metadata":{
                        "flowSystemMetadata":{
                           "swaggerOperationId":"OnNewEmailV3"
                        }
                     },
                     "type":"ApiConnectionNotification",
                     "inputs":{
                        "host":{
                           "connection":{
                              "name":"@parameters('$connections')['office365_1']['connectionId']"
                           }
                        },
                        "fetch":{
                           "queries":{
                              "folderPath":"Inbox",
                              "importance":"Any",
                              "fetchOnlyWithAttachment":false,
                              "includeAttachments":false,
                              "subjectFilter":"Environments On Demand : PRODUCTION - New Application Announcement"
                           },
                           "pathTemplate":{
                              "template":"/v3/Mail/OnNewEmail"
                           },
                           "method":"get"
                        },
                        "subscribe":{
                           "queries":{
                              "folderPath":"Inbox",
                              "importance":"Any",
                              "fetchOnlyWithAttachment":false
                           },
                           "body":{
                              "NotificationUrl":"@{listCallbackUrl()}"
                           },
                           "pathTemplate":{
                              "template":"/GraphMailSubscriptionPoke/$subscriptions"
                           },
                           "method":"post"
                        },
                        "authentication":"@parameters('$authentication')"
                     }
                  }
               },
               "actions":{
                  "Post_message":{
                     "runAfter":{

                     },
                     "metadata":{
                        "flowSystemMetadata":{
                           "swaggerOperationId":"PostMessage"
                        }
                     },
                     "type":"ApiConnection",
                     "inputs":{
                        "host":{
                           "connection":{
                              "name":"@parameters('$connections')['yammer']['connectionId']"
                           }
                        },
                        "method":"post",
                        "body":{
                           "group_id":16315823,
                           "body":"@triggerBody()?['bodyPreview']"
                        },
                        "path":"/messages.json",
                        "queries":{
                           "network_id":"Default"
                        },
                        "authentication":"@parameters('$authentication')"
                     }
                  }
               }
            },
            "parameters":{
               "$connections":{
                  "value":{
                     "yammer":{
                        "id":"[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('logicAppLocation'), '/managedApis/', 'yammer')]",
                        "connectionId":"[resourceId('Microsoft.Web/connections', parameters('yammer_Connection_Name'))]",
                        "connectionName":"[parameters('yammer_Connection_Name')]"
                     },
                     "office365_1":{
                        "id":"[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('logicAppLocation'), '/managedApis/', 'office365_1')]",
                        "connectionId":"[resourceId('Microsoft.Web/connections', parameters('office365_1_Connection_Name'))]",
                        "connectionName":"[parameters('office365_1_Connection_Name')]"
                     }
                  }
               }
            },
            "runtimeConfiguration":{
               "lifetime":{
                  "unit":"Day",
                  "count":30
               },
               "collections":{
                  "maximumItemCount":5000
               },
               "performanceProfile":{
                  "throttles":{
                     "mode":"Low"
                  }
               },
               "retryPolicy":{
                  "type":"Exponential",
                  "interval":"PT5M",
                  "count":2,
                  "minimumInterval":"PT5M",
                  "maximumInterval":"PT1H"
               }
            }
         }
      },
      {
         "type":"Microsoft.Web/connections",
         "apiVersion":"2016-06-01",
         "name":"[parameters('yammer_Connection_Name')]",
         "location":"[parameters('logicAppLocation')]",
         "properties":{
            "api":{
               "id":"[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('logicAppLocation'), '/managedApis/', 'yammer')]"
            },
            "displayName":"[parameters('yammer_Connection_Name')]"
         }
      },
      {
         "type":"Microsoft.Web/connections",
         "apiVersion":"2016-06-01",
         "name":"[parameters('office365_1_Connection_Name')]",
         "location":"[parameters('logicAppLocation')]",
         "properties":{
            "api":{
               "id":"[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('logicAppLocation'), '/managedApis/', 'office365_1')]"
            },
            "displayName":"[parameters('office365_1_Connection_Name')]"
         }
      }
   ]
}